# F04: グループ & チャット

最終更新: 2025-09-02 (Asia/Tokyo)

> F03（合意収集）によって成立した提案に基づき、参加者間のプライベートなチャットグループを生成・管理する機能。

---

## 1. 目的
- 合意が成立したメンバーが、具体的な調整やコミュニケーションを行えるようにする。
- Botによるファシリテーションを導入し、スムーズな日程調整などを支援する。

---

## 2. 機能概要（フレンド内）
- F03で提案が `agreed` になると、本機能がトリガーされ、新しいグループが自動生成される。
- グループには、提案者と受信者全員が自動的に参加する。
- 参加者は「提案者のフレンド」に限定（提案作成時の `audience_ids` はフレンドのみを許容）。
- 各グループには専用のチャット機能が用意される。
- グループ作成時、システムBotが最初のメッセージ（例：「合意が成立しました！日程を調整しましょう。」）を投稿する。

---

## 3. API / データ（Firebase）

- グループ作成は Functions のバックグラウンドトリガで自動実行（`proposals.status` が `agreed` へ遷移）。
- Firestore スキーマ（例）:
```
groups/{groupId} { title, originProposalId, createdAt }
groupMembers/{groupId}:{userId}
groupMessages/{groupId}/messages/{messageId} { senderId, kind, text, createdAt }
```
— 一覧/詳細/メッセージは Firestore から購読/取得。書き込みは Functions 経由に制限可（ルールで制御）。
**リアルタイム通信**
- 新規メッセージは、Firebase（Firestore購読）を通じてグループの全メンバーにリアルタイム配信。Flask で保存後に Firebase にミラーされる。

---

## 4. データモデル（Firebase 権威）
- グループ/メンバー/メッセージは Firestore で管理。
- 旧SQLスキーマ（docs/backend/data-model.md）は AI サービスのサーバDB構成向けで、現行では使用しません。

---

## 5. Botの役割
- **初期メッセージ**: グループ作成時に、合意成立を知らせるメッセージを自動投稿する。
- **日程調整の補助 (将来構想)**: 提案された日時候補を提示し、参加者の投票を促す。
- **リマインダー (将来構想)**: 予定の前日にリマインダーを送信する。

---

## 6. セキュリティとプライバシー
- グループのメンバーでないユーザーは、APIを通じてグループ情報やメッセージを取得することはできません。
- `GET /groups/{id}` や関連APIは、リクエスト元のユーザーがそのグループのメンバーであることを必ず検証する必要があります。
- グループ作成時、`member_ids` が作成者のフレンドであることを検証し、違反時は 403/422 を返す。

---

## 7. 受け入れ基準（AC）
- ✅ 提案が成立すると、関連メンバー全員が参加するグループが自動で作成される。
- ✅ グループ作成時、Botによる最初のメッセージが投稿される。
- ✅ グループのメンバーのみが、そのグループのメッセージを送受信できる。
- ✅ 自分が所属するグループの一覧を取得できる。
- ✅ グループの全メンバーは作成者のフレンドである。
