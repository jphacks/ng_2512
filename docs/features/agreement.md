# F03: 合意収集

最終更新: 2025-09-02 (Asia/Tokyo)

> F02（提案）に対して行われたリアクションを集計し、提案の成立・不成立を決定するバックエンド機能。

---

## 1. 目的
- 提案に対する参加者の意思を明確にし、自動的に次のステップ（グループチャット作成など）に進めるため。
- 提案者・参加者の双方に、手動での確認作業を不要にする。

---

## 2. 機能概要
ユーザーが提案にリアクションするたびに、合意形成ロジックが実行されます。

- **合意成立**: 提案の受信者（`audience`）**全員**が `like` した場合。
- **合意不成立**: 受信者のうち**誰か1人でも** `dislike` した場合、または提案の締切 (`expires_at`) を過ぎた場合。

合意が成立すると、関連するユーザーで構成される新しいグループ（F04）が自動的に作成されます。

---

## 3. トリガー
この機能は、以下のAPIが呼び出された際に実行されます。

- `POST /proposals/{id}/reaction`: ユーザーが提案にリアクションした時。
- また、バッチ処理やスケジューラにより、締切切れの提案を定期的にチェックする必要があります。

---

## 4. コアロジック

### 4.1 リアクション受信時の処理フロー
1. `POST /proposals/{id}/reaction` がリクエストされる。
2. `proposal_audiences` テーブルにユーザーのリアクション (`like` or `dislike`) を記録。
3. 当該 `proposal_id` の合意ステータスをチェック。

### 4.2 合意ステータスチェック
- **Dislikeチェック**: `proposal_audiences` に `dislike` が1件でも存在するか確認。
  - 存在する場合 → **合意不成立**。`proposals.status` を `rejected` に更新。
- **Likeチェック**: `dislike` がない場合、`audience` 全員のリアクションが `like` になっているか確認。
  - 全員が `like` の場合 → **合意成立**。`proposals.status` を `agreed` に更新し、「5. 合意成立時のアクション」を実行。
  - 全員が `like` ではない（`null` のリアクションが残っている）場合 → `pending` のまま何もしない。

### 4.3 締切切れの処理 (バッチ)
- 定期的に `proposals` テーブルをスキャンし、`status = 'pending'` かつ `expires_at < now()` の提案を検索。
- 対象の提案の `status` を `rejected` に更新。

---

## 5. 合意成立時のアクション

1.  **グループ作成**: F04の `POST /groups` を内部的に呼び出し、提案者と受信者全員を含む新しいグループを作成します。
    - グループ名は提案のタイトル (`proposals.title`) を利用。
2.  **通知送信**: 参加者全員に、合意が成立した旨を通知（プッシュ通知/アプリ内通知）します。

---

## 6. APIへの影響

- `POST /proposals/{id}/reaction`:
  - このAPIの内部で、本仕様書に記載のコアロジックが実行されます。
  - レスポンスとして、現在の提案ステータス (`pending`, `agreed`, `rejected`) を返却することが望ましい。

---

## 7. データモデルへの影響

- `proposals` テーブル:
  - `status` カラムが `pending` -> `agreed` または `rejected` に更新されます。
- `proposal_audiences` テーブル:
  - `reaction` カラムに `like` または `dislike` が記録されます。

---

## 8. 受け入れ基準（AC）
- ✅ 受信者全員が `like` すると、`proposals.status` が `agreed` に更新される。
- ✅ 合意成立時、提案者と受信者を含む新しいグループが作成される（F04連携）。
- ✅ 受信者のうち1人でも `dislike` すると、`proposals.status` が `rejected` に更新される。
- ✅ 提案の締切を過ぎると、`proposals.status` が `rejected` に更新される。
- ✅ 提案が成立/不成立になった際、参加者に通知が送られる。