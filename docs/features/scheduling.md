# F05: 日程調整 (カレンダー連携強化)

最終更新: 2025-09-02 (Asia/Tokyo)

> F04（グループ）内で、提案された複数の日時候補から参加日時を決定するための機能。外部カレンダーと連携し、空き時間を参考にしながら投票できる。

---

## 1. 目的
- 合意したメンバー間の最終的な日程調整を、チャットから離れずに効率的に完了させる。
- Botによる自動集計と通知により、幹事役の負担を軽減する。
- **外部カレンダーの空き時間情報を提示し、より確実な意思決定を支援する。**

---

## 2. 前提条件
- ユーザーが外部カレンダー（Google Calendarなど）との連携を許可していること。この連携機能自体は本仕様の範囲外とする。

---

## 3. 機能概要
- グループ作成後、BotがF02（提案）で提示された日時候補をチャット内に投票パネルとして投稿する。
- **この際、Botは各メンバーの外部カレンダー情報を参照し、候補日時が「空き時間」か「予定あり」かを自動で表示する。**
- グループメンバーは、各日時候補に対して「参加可能（OK）」「参加不可能（NG）」で投票する。
- Botは投票状況をリアルタイムで集計し、投票パネルの表示を更新する。
- 全員の投票が完了するか、特定の日時に全員が「OK」した場合、Botが最適な日時を自動で決定し、結果を通知する。
- ジャーナル/提案で共有された写真から VLM（Flask）で予定テキスト・参加候補を抽出し、初期候補としてパネルに反映する（ユーザーが編集可能）。

---

## 4. UI/UX (チャット内)

**投票パネルの表示例:**

> **[Bot]** 日程調整を始めましょう！
> 
> **週末にボードゲームカフェ**
> 
> **候補1: 9月13日(土) 14:00-18:00**
> 👤 Taro (予定あり), Jiro (空き時間), Hanako (不明)
> ✅ Jiro
> ❌ Taro
> [OK] [NG]
> 
> **候補2: 9月14日(日) 14:00-18:00**
> 👤 Taro (空き時間), Jiro (予定あり), Hanako (不明)
> ✅ Taro
> ❌ Jiro
> [OK] [NG]

- ユーザーは各候補の下にある `[OK]` `[NG]` ボタンをタップして投票する。
- **各候補には、自分のカレンダーにおける空き時間情報（空き時間 / 予定あり / 不明）が参考情報として表示される。**
- 投票すると、自分の名前が該当のリストに追加され、ボタンは選択済み状態になる。

---

## 5. API 定義

### 5.1 `POST /groups/{id}/scheduling/vote`
日時候補に対して投票します。
**Request Body**
```json
{
  "slot_id": 1, // proposal_slotsのID
  "vote": "ok" // "ok" or "ng"
}
```
**Processing**
1. `scheduling_votes` テーブルに投票を記録。
2. リアルタイムでグループメンバーに投票結果を配信（WebSocket）。
3. 日時決定ロジックを実行。

### 5.2 `GET /groups/{id}/scheduling`
現在の投票状況に加え、**各メンバーの空き時間情報**を返します。
**Response (追加情報)**
```json
{
  "slots": [
    {
      "id": 1,
      "start_time": "...",
      "end_time": "...",
      "votes": [
        {"user_id": 10, "vote": "ng"},
        {"user_id": 25, "vote": "ok"}
      ],
      "calendar_states": [
        {"user_id": 10, "state": "busy"}, // busy, free, unknown
        {"user_id": 25, "state": "free"},
        {"user_id": 31, "state": "unknown"}
      ]
    }
  ]
}
```

### 5.3 `POST /groups/{id}/scheduling/decide` (内部・手動用)
特定の日時を最終決定します。通常はBotが自動実行しますが、手動での決定も可能です。
**Request Body**
```json
{
  "slot_id": 2
}
```

---

## 6. データモデル

### `scheduling_votes` テーブル
```sql
CREATE TABLE scheduling_votes (
    slot_id BIGINT NOT NULL REFERENCES proposal_slots(id) ON DELETE CASCADE,
    user_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    vote TEXT NOT NULL, -- 'ok', 'ng'
    created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
    PRIMARY KEY (slot_id, user_id)
);
```

### `groups` テーブルへの追加カラム
```sql
ALTER TABLE groups ADD COLUMN decided_slot_id BIGINT REFERENCES proposal_slots(id);
```

> **Note:** カレンダーの空き時間情報は、都度外部APIから取得するか、別テーブルにキャッシュする。その詳細設計は本仕様の範囲外とする。

---

## 7. Botの役割とロジック

- **投票の開始**: グループ作成後、F02の提案に含まれる日時候補 (`proposal_slots`) を元に、投票パネルを投稿する。**この時、参加メンバーの外部カレンダー情報を並行して取得し、空き時間情報をパネルに含める。**
- **投票の集計**: `POST .../vote` が呼ばれるたびに、投票状況をWebSocketでブロードキャストする。
- **日時の自動決定**: 
  1. いずれかの候補に、グループの**全メンバー**から `ok` 票が集まった場合、その候補を「決定」とする。
  2. 全メンバーが全ての候補に投票完了した時点で、`ok` 票が最も多い候補を「決定」とする。
     - `ok` 票が同数の候補が複数ある場合は、より早い日時を優先する。
- **結果の通知**: 日時が決定したら、「日時が決定しました: 9月14日(日) 14:00-18:00」のようなメッセージを投稿し、`groups.decided_slot_id` を更新する。
- **リマインダー**: 決定した日時の前日に、リマインダーメッセージを投稿する。

---

## 8. 受け入れ基準（AC）
- ✅ グループ作成後、Botが自動で日程調整を開始する。
- ✅ **投票パネルには、各メンバーの候補日時に対するカレンダーの空き時間（または予定あり）が表示される。**
- ✅ メンバーはチャット内で各日時候補に投票できる。
- ✅ 投票状況はリアルタイムで他のメンバーにも反映される。
- ✅ 全員が「OK」した日時、または投票完了時に最も「OK」が多かった日時が自動で決定される。
- ✅ 日時決定後、Botが結果をチャットに通知する。
- ✅ 決定した日時の前日に、Botがリマインダーを送信する。
