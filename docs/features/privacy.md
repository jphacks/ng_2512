# F08: プライバシー/通報/ブロック

最終更新: 2025-09-02 (Asia/Tokyo)

> ユーザーが安心してアプリを利用できるよう、不快なユーザーとの接触を断ち、利用規約に違反する行為を運営に報告するための機能群。

---

## 1. 目的
- ユーザーの安全性を確保し、健全なコミュニティを維持する。
- ユーザー自身がプライバシーをコントロールし、不快な体験を未然に防げるようにする。
- 利用規約違反に対して、迅速な対応を可能にするプロセスを確立する。

---

## 2. 機能概要

- **ブロック機能**: 特定のユーザーを指定して、以降のあらゆるインタラクションを遮断する。ブロックされた側がその事実に気づきにくい「サイレントブロック」方式を採用する。
- **通報機能**: 不適切なプロフィール、提案、チャットメッセージなどを、理由を添えて運営に報告する。

---

## 3. ブロック機能の詳細

ブロックは非対称な挙動を取ることで、ブロックされた側がその事実を特定できないように設計する。

- **ブロックした側（Aさん）から見た挙動**:
  - ブロックした相手（Bさん）のプロフィール、提案、メッセージ、検索結果など、全ての情報がアプリ上から表示されなくなる。

- **ブロックされた側（Bさん）から見た挙動**:
  - Bさんの画面上では、Aさんのプロフィールや過去のやりとりは**通常通り表示され続ける**。
  - BさんはAさんに対して、提案やメッセージ送信などの操作を**通常通り行えるように見える**。
  - しかし、BさんからAさんへのアクションは、全て**サーバー側で破棄**され、Aさんには一切届かない。
  - Bさんのクライアント上では送信成功と表示されるが、Aさん側では何も起こらない。

- **通知の不在**: ブロックしたこと、されたことは相手に通知されない。
- **解除**: ブロックはいつでも解除できる。解除すると、再び相互のやりとりが可能になる。

---

## 4. 通報機能の詳細

- **通報対象**: ユーザー、提案、個別のチャットメッセージなどを対象として通報できる。
- **通報理由**: 以下の選択肢から理由を選択する。
  - スパムまたは詐欺
  - 嫌がらせやヘイトスピーチ
  - 不適切なコンテンツ（暴力的、性的など）
  - なりすまし
  - その他
- **処理**: 通報内容は運営チームに送信される。運営は内容を確認し、警告、アカウントの一時停止、永久追放などの措置を講じる。

---

## 5. API 定義

### 5.1 `POST /users/{id}/block`
特定のユーザーをブロックします。

### 5.2 `DELETE /users/{id}/block`
ユーザーのブロックを解除します。

### 5.3 `GET /users/me/blocks`
自分がブロックしているユーザーの一覧を取得します。

### 5.4 `POST /reports`
ユーザーやコンテンツを通報します。
**Request Body**
```json
{
  "report_type": "user", // "user", "proposal", "message"
  "reported_id": 456, // 対象のID
  "reason_code": "spam", // "spam", "harassment", etc.
  "comment": "プロフィールに不適切な画像が使われています。"
}
```

---

## 6. データモデル

### `blocks` テーブル
```sql
CREATE TABLE blocks (
    blocker_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE, -- ブロックしたユーザー
    blocked_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE, -- ブロックされたユーザー
    created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
    PRIMARY KEY (blocker_id, blocked_id)
);
```

### `reports` テーブル
```sql
CREATE TABLE reports (
    id BIGSERIAL PRIMARY KEY,
    reporter_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    report_type TEXT NOT NULL,
    reported_id BIGINT NOT NULL,
    reason_code TEXT NOT NULL,
    comment TEXT,
    status TEXT NOT NULL DEFAULT 'pending', -- pending, investigating, resolved
    created_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);
```

---

## 7. 他機能への影響
- **F02 (提案)**: 提案作成時、サーバーは`audience`に提案者（自分）をブロックしているユーザーが含まれていないか検証する。含まれている場合、そのユーザーへの提案は送信されない（ただし、クライアントには成功したように見せる）。
- **F04 (チャット)**: メッセージ送信時、サーバーは宛先グループのメンバーに自分をブロックしているユーザーがいないか検証する。いる場合、そのユーザーへのメッセージは送信されない。
- **F07 (SNS友だちインポート)**: 「知り合いかも？」リストに、自分をブロックしている、または自分がブロックしているユーザーは表示されない。
- **各種検索**: ユーザー検索などの結果から、自分がブロックしているユーザーは除外される。

---

## 8. 受け入れ基準（AC）
- ✅ 特定のユーザーをブロックできる。
- ✅ ブロック後、ブロックした相手の情報が自分のアプリから見えなくなる。
- ✅ ブロックされた側は、ブロックされたことに気づかない（相手のプロフィールは引き続き表示され、メッセージ送信などの操作も表面上は可能）。
- ✅ ブロックされた側からブロックした側への提案やメッセージは、実際には届かない。
- ✅ ブロックしているユーザーの一覧を確認し、解除できる。
- ✅ 不適切なユーザーやコンテンツを、理由を添えて通報できる。
