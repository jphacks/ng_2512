# F12: AIアシスタントによる提案サジェスト

最終更新: 2025-09-02 (Asia/Tokyo)

> ユーザーのアクション（思い出ジャーナルへの投稿など）をきっかけに、Flaskサーバー上のローカルAIが再会の提案を自動生成し、プッシュ通知で「送信しますか？」と問いかける機能。外部AIサービスは利用しません。

---

## 1. 目的
- ユーザーが提案を考える手間すら意識することなく、再会のきっかけを得られるようにする。
- アプリがユーザーの状況を理解し、気の利いた提案をしてくれる「賢いアシスタント」としての体験を提供する。
- 「この提案はAIが作ったかもしれない」という可能性を生むことで、人間が手動で提案する際の心理的ハードルを下げる。

---

## 2. 機能概要
- ユーザーがF14「思い出ジャーナル」に写真を投稿すると、バックエンドのジョブが起動。
- サーバの CLIP/顔認識/LLM によりテーマ/宛先候補/文面を生成し、「ドラフト」としてDBに保存。
- 適切なタイミングでプッシュ通知（F06）を送信し、「送信しますか？」を提示。
- 承認時にドラフトを `pending` 提案として送信。

---

## 3. UI/UX
- **ユーザーが直接操作するUIは、プッシュ通知が中心となる。**
- **プッシュ通知**: 
  - タイトル: 「AIからの提案があります」
  - 本文: 「（Taroさん、Jiroさん）と、またカフェに行きませんか？」
  - アクションボタン: `[送信する]` `[詳細を見る]` `[今はしない]`
- **詳細画面**: 「詳細を見る」をタップすると、AIが生成した提案（宛先、タイトル、本文など）の確認画面が開く。
- **ワンタップ承認**: 「送信する」をタップすると、即座に提案が送信され、「提案を送信しました」というフィードバック通知が表示される。

---

## 4. API 定義

### 4.1 `POST /proposals/{id}/approve_and_send`
通知されたドラフト提案を承認し、送信する。
- Trigger: 通知アクションから呼び出し
- Processing: `status='draft'` を検証→`pending` へ変更→受信者に通知

---

## 5. 実装フロー

1.  トリガー: ユーザーが F14 に写真を投稿（`asset_id` 発行）。
2.  非同期処理: ジョブキューが AI 提案生成ジョブを開始。
3.  提案生成: CLIP/ArcFace による解析→LLM でタイトル/本文/候補日時→`proposals(status='draft')` へ保存。
4.  通知: FCM/APNs で承認依頼のプッシュ通知を送付。
5.  承認: `POST /proposals/{id}/approve_and_send` で送信、以降は F02/F03/F06 の通常フロー。

---

## 6. AI/MLモデル（サーバ）

- 画像: OpenCLIP (ViT-B/32) ONNX/PyTorch
- 顔: ArcFace/MobileFaceNet（512次元）
- 文章: chatgpt-oss-20b（vLLM 推奨）。短文テンプレ最適化、温度/最大トークンは設定化

---

## 7. 受け入れ基準（AC）
- ✅ ユーザーが複数人の友人と写った写真をジャーナルに投稿すると、後ほどAIから提案の通知が届く。
- ✅ 通知の「送信する」ボタンをタップするだけで、提案が相手に送信される。
- ✅ 提案を受け取った側には、それがAIによって作られたことは明示されない。
- ✅ ユーザーがAI提案の通知を無視した場合、提案は送信されない。
- ✅ AIによって生成される提案の内容が、元の写真の文脈に合っている。
