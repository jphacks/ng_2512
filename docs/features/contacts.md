# F07: SNS友だちインポート

最終更新: 2025-09-02 (Asia/Tokyo)

> ユーザーが利用している他のSNSアカウントと連携し、アプリ内で繋がる友人を見つけやすくする機能。本機能は任意であり、プライバシー保護を最優先に設計される。

---

## 1. 目的
- ユーザーが手動で友人を探したり、招待したりする手間を削減する。
- 既存のソーシャルグラフを活用し、アプリ内でのコミュニティ形成を迅速に促進する。

---

## 2. 機能概要
- ユーザーが明示的に許可した場合にのみ、外部SNS（例: X, Facebook）のAPIにアクセスし、友だちリストを取得する。
- 取得した友だちリストと、アプリの既存ユーザーで同じSNSを連携しているユーザーとを照合する。
- マッチした友人を「知り合いかも？」として一覧表示し、ユーザーが選択してアプリ内の連絡先に追加できる。
- 本機能は完全に任意であり、利用しなくてもアプリのコア機能は問題なく使える。

---

## 3. プライバシーとセキュリティ

- **OAuthによる認可**: SNS連携はOAuth2.0に準拠する。友だちリストの取得に必要な最小限のスコープ（権限）のみをユーザーに要求する。
- **取得情報の透明性**: 連携時に、どの情報（例: 「Xの友だちリスト」）にアクセスするかを明確にユーザーに提示する。
- **アクセストークンの管理**: クライアントは、SNSから得たアクセストークンを友だちリスト取得のために一時的に利用するのみで、サーバーに送信・保存しない。
- **プライバシーポリシー**: どのSNSと連携し、何の情報をどのように利用するかをプライバシーポリシーに明確に記載する。

---

## 4. API 定義

### 4.1 `POST /contacts/sync/sns`
連携したSNSの友だち情報と、アプリ内の既存ユーザーをマッチングさせます。
**Request Body**
```json
{
  "sns_type": "x", // "x", "facebook", etc.
  "friend_sns_ids": ["sns_id_1", "sns_id_2", "..."],
}
```
**Response**
```json
{
  "matched_users": [
    {"id": 123, "display_name": "Taro", "photo_url": "..."},
    {"id": 456, "display_name": "Hanako", "photo_url": "..."}
  ]
}
```

### 4.2 `POST /contacts`
特定のユーザーを連絡先に追加します。（変更なし）

### 4.3 `GET /contacts`
自分が追加した連絡先の一覧を取得します。（変更なし）

### 4.4 `DELETE /contacts/{user_id}`
特定のユーザーを連絡先から削除します。（変更なし）

---

## 5. データモデル

### `contacts` テーブル
変更なし。

### `users` テーブルへの追加カラム
マッチングのために、連携したSNSのユーザーIDを保持します。
```sql
-- 既存の phone_hash, email_hash は削除またはNULL許容に変更
ALTER TABLE users ADD COLUMN x_id TEXT UNIQUE;
ALTER TABLE users ADD COLUMN facebook_id TEXT UNIQUE;
-- etc.
```

---

## 6. 実装フロー

1.  **クライアント**: ユーザーが「Xと連携して友だちを探す」ボタンをタップ。
2.  **クライアント**: OAuth認証フローを開始。アプリ内ブラウザでXの認可画面を表示。
3.  **クライアント**: ユーザーが認可後、リダイレクトされてきたコールバックURLからアクセストークンを取得。
4.  **クライアント**: 取得したアクセストークンを使い、XのAPIを叩いて友だちリスト（ユーザーIDのリスト）を取得。
5.  **クライアント**: 取得した友だちのSNS IDリストを、`POST /contacts/sync/sns` でサーバーに送信。
6.  **サーバー**: リクエストで受け取ったSNS IDリストと、`users`テーブルの`x_id`カラムを照合。
7.  **サーバー**: マッチしたユーザー（ただし、すでに`contacts`テーブルに存在する関係は除く）のリストをクライアントに返す。
8.  **クライアント**: サーバーから受け取ったユーザーリストを「知り合いかも？」として画面に表示する。

---

## 7. 受け入れ基準（AC）
- ✅ ユーザーが許可しない限り、SNSアカウントにアクセスしない。
- ✅ SNS連携は任意であり、スキップ可能である。
- ✅ 連携したSNSの友だちがアプリを利用している場合、「知り合いかも？」に表示される。
- ✅ 「知り合いかも？」リストからユーザーを連絡先に追加できる。
- ✅ ユーザーのSNSアクセストークンが、自社サーバーに保存されない。
